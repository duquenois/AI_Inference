<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>쿠파의 성 위치 추론 AI</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg:#f4f7fa; --ink:#1f2937; --muted:#6b7280;
      --blue1:#60a5fa; --blue2:#a78bfa;
      --green1:#34d399; --green2:#10b981;
      --card:#ffffff; --shadow:0 4px 12px rgba(0,0,0,.1);
      --radius:12px;
    }
    body {
      margin:0; padding:24px;
      font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Arial;
      background:var(--bg); color:var(--ink); text-align:center;
    }
    h1 { margin:.2rem 0 8px }
    p.lead { margin:0 0 18px; color:var(--muted) }

    .input-col {
      width:min(560px,92vw); margin:0 auto 12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .input-col input {
      width:100%; padding:12px 14px;
      border:1px solid #d1d5db; border-radius:10px;
      font-size:14px; background:#fff;
    }
    .btns { margin:8px 0 18px }
    .btn {
      display:inline-block; padding:10px 16px;
      border:none; border-radius:10px; cursor:pointer;
      color:#fff; font-weight:600; margin:0 6px; transition:.2s;
    }
    .btn.primary { background:#3b82f6 }
    .btn.secondary { background:#6b7280 }
    .btn:hover { filter:brightness(.95) }

    .box {
      width:min(900px,95vw); margin:16px auto;
      background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px;
    }
    #svgBox{padding:24px}
    #stepSvg{display:block;margin:0 auto}

    #steps {
      width:min(700px,95vw); margin:18px auto 0;
      display:flex; flex-direction:column; gap:12px;
    }
    .step {
      background:linear-gradient(135deg,var(--blue1),var(--blue2));
      color:#fff; font-weight:700; padding:12px 16px;
      border-radius:12px; box-shadow:var(--shadow);
      transform:translateY(12px); opacity:0;
      animation:fadeIn .5s forwards;
    }
    .result-box, .chart-box {
      background:linear-gradient(135deg,var(--green1),var(--green2));
      color:#fff; border-radius:var(--radius);
      box-shadow:0 6px 14px rgba(16,185,129,.25);
      padding:18px 20px; text-align:left;
      transform:translateY(12px); opacity:0;
      animation:fadeIn .5s forwards;
    }
    .chart-box { background:#fff; color:#111; text-align:center; }
    .chart-title{margin:0 0 8px; font-weight:700}
    .chart{width:100%}
    .result-title{font-size:18px; font-weight:800; margin:0 0 6px}
    .result-desc{margin:0; opacity:.95; line-height:1.5}

    @keyframes fadeIn { to{opacity:1; transform:translateY(0)} }

    /* 팝업 */
    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      color: #111;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.3);
      padding: 24px 28px;
      width: min(420px, 90%);
      z-index: 1001;
      text-align: center;
    }
    .popup h2 { margin: 0 0 12px; font-size: 20px; font-weight: 800; }
    .popup p { margin: 0 0 16px; line-height: 1.5; }
    .popup button {
      background: #3b82f6; border: none;
      color: #fff; font-weight: 600;
      border-radius: 8px; padding: 10px 18px;
      cursor: pointer;
    }
    .popup button:hover { filter: brightness(.95); }
    .overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,.4);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h1>쿠파의 성 위치 추론 AI</h1>
  <p class="lead">5개의 힌트를 입력하면 단계별 추론 후 최종 정답을 도출합니다.</p>

  <div class="input-col">
    <input id="s1" placeholder="첫 번째 힌트를 입력하세요" />
    <input id="s2" placeholder="두 번째 힌트를 입력하세요" />
    <input id="s3" placeholder="세 번째 힌트를 입력하세요" />
    <input id="s4" placeholder="네 번째 힌트를 입력하세요" />
    <input id="s5" placeholder="다섯 번째 힌트를 입력하세요" />
  </div>

  <div class="btns">
    <button class="btn primary" onclick="startReasoning()">추론 시작</button>
    <button class="btn secondary" onclick="resetAll()">초기화</button>
  </div>

  <div class="box" id="svgBox">
    <svg id="stepSvg" width="900" height="160"></svg>
  </div>

  <div id="steps"></div>

  <!-- 팝업 -->
  <div id="popupOverlay" class="overlay" style="display:none;"></div>
  <div id="answerPopup" class="popup" style="display:none;">
    <h2>정답 추론 결과</h2>
    <p id="answerText"></p>
    <button onclick="closePopup()">닫기</button>
  </div>

  <script>
    const STEP_LABELS = [
      "입력 텍스트 전처리",
      "텍스트 특징 추출",
      "중간 가설 생성",
      "후보 답안 갱신",
      "최종 정답 도출"
    ];
    const SPECIAL_INPUTS = [
      "성벽 위에는 뾰족한 가시 장식이 빽빽하게 솟아 있다.",
      "붉은 용암빛이 성문의 돌 틈새로 새어 나온다.",
      "다른 성과 달리 지붕이 검은 철판으로 덮여 있다.",
      "성 꼭대기 탑은 거대한 해골 모양으로 장식되어 있다.",
      "다리 난간에는 불꽃 모양의 조각상이 줄지어 서 있다."
    ];
    const SPECIAL_OUTPUT = "쿠파의 성은 오른쪽에 위치한 성이다.";

    function softmax(arr){
      const m=Math.max(...arr); const e=arr.map(v=>Math.exp(v-m));
      const s=e.reduce((a,b)=>a+b,0); return e.map(v=>v/s);
    }

    function startReasoning(){
      resetVisuals();
      const inputs=[1,2,3,4,5].map(i=>document.getElementById('s'+i).value.trim());
      if(inputs.some(v=>!v)){alert("5개의 문장을 모두 입력해 주세요.");return;}

      const svg=d3.select('#stepSvg');
      const svgEl=document.getElementById('stepSvg');
      const BOX_MAX=900; const W=Math.min(BOX_MAX,Math.floor(window.innerWidth*0.95));
      svgEl.setAttribute('width',W);

      const nodes=["S1","S2","S3","S4","S5","확률","키워드","정답"];
      const cx0=70, cy=80, r=26;
      const stepGap=(W-cx0*2)/(nodes.length-1);

      const addSvgNode=(label,i)=>{
        const x=cx0+i*stepGap;
        svg.append('circle').attr('cx',x).attr('cy',cy).attr('r',0).attr('fill','#60a5fa')
          .transition().duration(500).attr('r',r);
        svg.append('text').attr('x',x).attr('y',cy+6).attr('text-anchor','middle')
          .attr('fill','#fff').style('font-weight',700).style('opacity',0).text(label)
          .transition().delay(520).duration(220).style('opacity',1);
        if(i>0){
          const x1=cx0+(i-1)*stepGap+r, x2=x-r;
          svg.append('line').attr('x1',x1).attr('y1',cy).attr('x2',x1).attr('y2',cy)
            .attr('stroke','#9ca3af').attr('stroke-width',2)
            .transition().duration(500).attr('x2',x2);
        }
      };

      const stepDelay=900;
      for(let i=0;i<5;i++){
        setTimeout(()=>{ addSvgNode(nodes[i],i); addStepCard(`Step ${i+1}: ${STEP_LABELS[i]}`); },i*stepDelay);
      }
      setTimeout(()=>{addSvgNode("확률",5); showProb(inputs)},5*stepDelay);
      setTimeout(()=>{addSvgNode("키워드",6); showKeyword(inputs)},6*stepDelay);
      setTimeout(()=>{addSvgNode("정답",7); showSentence(inputs)},7*stepDelay);
    }

    function addStepCard(text){
      const steps=document.getElementById('steps');
      const div=document.createElement('div');
      div.className='step'; div.textContent=text;
      steps.prepend(div);
    }

    function tokenizeJoined(inputs){
      const joined=inputs.join(' ').replace(/['"‘’“”]+/g,' ').replace(/\s+/g,' ').trim();
      let toks=joined.split(/[^가-힣a-zA-Z0-9]+/).filter(t=>t.length>1);
      toks=toks.map(t=>t.replace(/(은|는|이|가|을|를|의|에|에서|으로|로|와|과|있다|한다|니다)$/,"")).filter(t=>t.length>0);
      return toks;
    }

    function showProb(inputs){
      const tokens=tokenizeJoined(inputs);
      const freqScore={};
      tokens.forEach((t,i)=>{ let s=1.0; s+=0.5*(tokens.length-i)/tokens.length; if(t.length>=3) s+=0.25; freqScore[t]=(freqScore[t]||0)+s; });
      let sorted=Object.entries(freqScore).sort((a,b)=>b[1]-a[1]).map(([token,score])=>({token,score}));
      if(sorted.length===0) sorted=[{token:"Unknown",score:1},{token:"None",score:.9},{token:"Etc",score:.8}];
      const top3=sorted.slice(0,3);
      const probs=softmax(top3.map(d=>d.score));
      const candidates=top3.map((d,i)=>({token:d.token,prob:probs[i]}));

      const steps=document.getElementById('steps');
      const div=document.createElement('div');
      div.className='chart-box';
      div.innerHTML=`<div class="chart-title">후보 확률 분포</div><svg id="probChart" class="chart" width="700" height="260"></svg>`;
      steps.prepend(div);

      drawChart(candidates);
    }

    function drawChart(candidates){
      const chart=d3.select('#probChart'); chart.selectAll('*').remove();
      const W=700, H=260, x0=70, y0=200;
      const x=d3.scaleBand().domain(candidates.map(d=>d.token)).range([x0,W-40]).padding(0.35);
      const y=d3.scaleLinear().domain([0,1]).range([y0,20]);
      chart.append('g').attr('transform',`translate(0,${y0})`).call(d3.axisBottom(x));
      chart.append('g').attr('transform',`translate(${x0},0)`).call(d3.axisLeft(y).ticks(5).tickFormat(d=>`${Math.round(d*100)}%`));
      chart.selectAll('rect.bar').data(candidates).enter().append('rect').attr('class','bar')
        .attr('x',d=>x(d.token)).attr('y',y0).attr('width',x.bandwidth()).attr('height',0).attr('fill','#60a5fa')
        .transition().duration(600).attr('y',d=>y(d.prob)).attr('height',d=>y0-y(d.prob));
      chart.selectAll('text.val').data(candidates).enter().append('text')
        .attr('x',d=>x(d.token)+x.bandwidth()/2).attr('y',d=>y(d.prob)-6)
        .attr('text-anchor','middle').style('font-weight',700).style('fill','#374151')
        .text(d=>`${(d.prob*100).toFixed(0)}%`);
    }

    function showKeyword(inputs){
      const tokens=tokenizeJoined(inputs);
      const counts={}; tokens.forEach(t=>counts[t]=(counts[t]||0)+1);
      const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      const top=sorted[0]||["Unknown",1];

      const div=document.createElement('div');
      div.className='result-box';
      div.innerHTML=`<div class="result-title">키워드 추론: '${top[0]}' (98%)</div>
        <p class="result-desc">입력된 문장에서 '${sorted.slice(0,3).map(s=>s[0]).join(", ")}' 등이 핵심 단서로 관찰되었습니다. 이 중 '${top[0]}'이(가) 98% 확률로 최종 후보로 선택되었습니다.</p>`;
      document.getElementById('steps').prepend(div);
    }

    /* 정답 판정 부분 수정 */
    function normalizeText(text){
      return text.replace(/[.\s]/g,"").trim(); // 마침표, 공백 제거
    }

    function showSentence(inputs){
      const normalizedInputs = inputs.map(v=>normalizeText(v));
      const normalizedSpecial = SPECIAL_INPUTS.map(v=>normalizeText(v));

      const isCorrect =
        normalizedInputs.length === normalizedSpecial.length &&
        normalizedInputs.slice().sort().join("|") === normalizedSpecial.slice().sort().join("|");

      let message;
      if(isCorrect){
        message = SPECIAL_OUTPUT;
      } else {
        message = "제대로 찾지 못했습니다. 힌트 문장을 정확히 다시 입력하세요.";
      }

      const div=document.createElement('div');
      div.className='result-box';
      div.innerHTML=`<div class="result-title">정답 추론</div>
        <p class="result-desc">${message}</p>`;
      document.getElementById('steps').prepend(div);

      openPopup(message);
    }

    function openPopup(message){
      document.getElementById("popupOverlay").style.display="block";
      document.getElementById("answerPopup").style.display="block";
      document.getElementById("answerText").textContent = message;
    }
    function closePopup(){
      document.getElementById("popupOverlay").style.display="none";
      document.getElementById("answerPopup").style.display="none";
    }

    function resetVisuals(){
      document.getElementById('steps').innerHTML='';
      d3.select('#stepSvg').selectAll('*').remove();
    }
    function resetAll(){
      ['s1','s2','s3','s4','s5'].forEach(id=>document.getElementById(id).value='');
      resetVisuals();
      closePopup();
    }
  </script>
</body>
</html>
